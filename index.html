<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
  	<title>sheetsee.js | example</title>
		
		<link rel="profile" href="http://gmpg.org/xfn/11">
		<link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Arvo:400,700,400italic,700italic'  type='text/css'>
		<link rel="stylesheet" href="css/normalize.css" type="text/css">
		<link rel="stylesheet" href="css/style.css" type="text/css">
		<link rel="stylesheet" href="leaflet.css" type="text/css">
		<script type="text/javascript" src="js/sheetsee.js"></script>
		<script type="text/javascript" src="js/tabletop.js"></script>
		<script type="text/javascript" src="js/jquery-1.8.2.min.js"></script> 
		<script type="text/javascript" src="js/ICanHaz.js"></script> 
		<script type="text/javascript" src="js/d3.v2.js"></script> 
		<script type="text/javascript" src="js/accounting.js" ></script>
		<script type="text/javascript" src="js/leaflet.js"></script>
		<script type="text/javascript" src="js/modernizr.custom.33965.js"></script>		
</head>

<body>   
	<div id="pagewrapper">
		<div id="header"></div><!-- #header END -->
     
	<div id="sidebar">
	</div><!-- #sidebar END -->  
       
  <div id="maincontainer" class="overview" >
  
	  <div class="articleHolder">
	    <h3>One Nation, Under the Gun</h3>
	      <div id="stats" ></div><!-- holds spot for stats -->
	      	<ul>
				<li onclick = "filterMap(0)" >week one</li>
				<li onclick = "filterMap(1)" >week two</li>
				<li onclick = "filterMap(2)" >week three</li>
				<li onclick = "filterMap(3)" >week four</li>
				<li onclick = "filterMap(4)" >week five</li>
				<li onclick = "filterMap(5)" >week six</li>
				<li onclick = "filterMap(6)" >week seven</li>
			</ul>
			<div id="map" class="fullmap"><img class="spinner" src="images/fbi_spinner.gif"></div><!-- holds spot for map -->
	      <div class="clear"></div>
	  </div><!-- end holder -->

	  <div class="articleHolder">
	    <h3>Category Funding Comparison</h3>
	      <p>Below, a funds comparison between the Foucs Areas in Economic Development.</p>
	      <div id="holder"></div><!-- holds spot for bar chart -->
	      <div id="holder2"></div><!-- holds spot for bar chart -->
        <div id="table" style="height: 500px; background: #ff00ff;"></div><!-- holds spot for table -->
	  </div><!-- end holder -->
						 
	</div><!-- end #maincontainer -->
	 

	</div><!-- #pagewrapper end -->
						        
<!-- commence setting up the charts for mustache.js -->
			
<script id="stats" type="text/html">// format stats
	<h5>There have been {{totalFatalities}} gun fatalities since the Sandy Hook Elementary School shooting. Among the victims, {{noMen}} were men, {{noWomen}} were women. Since the Newtown incident, there have been {{highestStateCount}} deaths by firearm in {{highestState}}, more than any other state in the country.</h5>
</script>

<script id="table" type="text/html">// format stats
  <table>
  <thead>
  <tr class="tableheader">
  <th>NAME</th><th>AGE</th><th>GENDER</th><th>DATE</th><th>CITY</th><th>STATE</th>
  </tr>
  </thead>
  {{#rows}}
    <tr><td class = "project">{{name}}</td><td class="total">{{age}}</td><td class="yrdolls">{{gender}}</td><td class="yrdolls">{{date}}</td><td class="yrdolls">{{city}}</td><td class="yrdolls">{{state}}</td></tr>
  {{/rows}}
  </table>
</script>
  
			
<script type="text/javascript"> // make all the good stuff!   
  document.addEventListener('DOMContentLoaded', function() { // IE6 doesn't do DOMContentLoaded
     loadSpreadsheet(showInfo)
   })    
	 
   function showInfo(data) {

   	theData = data 

		function getColumnSum (data, columnToSum) {
		  if (projects = []) return "0"
		  var columnSum = []
		  data.forEach(function (element) {
		    if (element.columnToSum === "") return 
		    columnSum.push(+element.columnToSum) 
		  })
		  return columnSum.reduce(function(a,b) {
		    return a + b
		  })
		}

		function filterData (data, filterTerm, columnName) {
			var filteredProjects = []
	  		data.forEach(function (element) {
	    var dataType = element[columnName]
	    if (dataType === filterTerm) filteredProjects.push(element)
	  })
	  return filteredProjects
		}

		function mostFrequent(data) {
			var stateCount = {};
   		for (var i = 0; i < data.length; i++)  {
       if (!stateCount[data[i].state]) {
           stateCount[data[i].state] = 0;
       }
       stateCount[data[i].state]++
   }
   			var sortable = [];
 				for (var state in stateCount) {
      		sortable.push([state, stateCount[state]]);
      }
 					sortable.sort(function(a, b) {return b[1] - a[1]})
   				return	sortable[0];
		}

		 L.Icon.Default.imagePath = "images/"
     accounting.settings.currency.precision = 0
     // var pageParent = "CA" // get Parent Page name which is Category
     // var pageName = "incident number" // get Page name which is Focus Area
     // var thePageParent = getType(data, pageParent) // Filter to array of Category
     // var thePageName  = getProject(theData, pageName) // Filte to object of Focus Area
 
     // make map 

     //var map = loadMap();

     makeMap(loadMap(), filterByDate(
                 new Date().getTime(), 
                 new Date(new Date().getTime()-1000*60*60*24*7).getTime()
             )
     );

     // var noProjsInCat = thePageParent.length 
     // if user's browswer doesn't support SVG, tell them

      maleData = filterData(theData, "M", "gender")
      femaleData = filterData(theData, "F", "gender")
      adultData = filterData(theData, "3", "ageGroup")
      teenData = filterData(theData, "2", "ageGroup")
      childData = filterData(theData, "1", "ageGroup")


      menVwomen = [{"label": "men", "units": maleData.length, "hexcolor": "#ff00ff"}, {"label": "women", "units": femaleData.length, "hexcolor": "#fff000"}]
      ageRange = [{"label": "adults", "units": adultData.length, "hexcolor": "#ff00ff"}, {"label": "teens", "units": teenData.length, "hexcolor": "#ff0fff"}, {"label": "children", "units": childData.length, "hexcolor": "#ffff00"}]



     if (Modernizr.svg) {
     	renderGraph(ageRange, ageRange.length, "#holder") 
     	renderGraph(menVwomen, menVwomen.length, "#holder2") 
     }
       else sorrySVG("#holder") 
     function sorrySVG(divTown) {
       $(divTown).text("Sorry, to see the chart you'll need to update your browser. <a href='https://www.google.com/intl/en/chrome/browser/'>Google Chrome</a> is great.")
     }
    	// These define the tables  	
      // -- quick stats table



      var stats = ich.stats({
        totalFatalities : theData.length,
        noMen : filterData(theData, "M", "gender").length,
        noWomen : filterData(theData, "F", "gender").length,
        highestState : mostFrequent(theData)[0],
        highestStateCount : mostFrequent(theData)[1]
      })
      $('#stats').html(stats)

    var table = ich.table({
      "rows" : theData
      })
      $('#table').html(table)

    }

	function filterMap(weeks) {        
		var week = 1000*60*60*24*7;
		makeMap(loadMap(), filterByDate(
				new Date(new Date().getTime()-week*weeks).getTime(),
                new Date(new Date().getTime()-week*(weeks+1) ).getTime()
            )
    	);
	}


var makeMap = function(map, filter) {
        for (var i = 0; i < theData.length; i++) {
            var data = theData[i];
            if (data.lng && data.lat && filter(data)) {
                displayAddress(map, data);
            }
        }
    }


var filterByDate = function(end_date, begin_date) {
        return function(data) {
            if (!data.time) {
                data.time = new Date(data.date).getTime();
            }
            return (data.time < end_date && data.time > begin_date);
        };
    }
    


</script>
</body>
</html>
